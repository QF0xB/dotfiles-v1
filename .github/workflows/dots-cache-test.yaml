name: Auto Flake Update, Test, and Cache Push

on:
  schedule:
    # Every 3 days at 03:00 UTC
    - cron: "0 3 */3 * *"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  update-test-cache:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1️⃣ Install Determinate Nix (with flakes & sandboxing)
      - uses: DeterminateSystems/nix-installer-action@v11

      # 2️⃣ Run automatic flake update and create a PR
      - uses: DeterminateSystems/update-flake-lock@v21
        with:
          pr-title: "auto: nix flake update"
          commit-msg: "auto: nix flake update"
          git-author-name: "GitHub Actions"
          git-author-email: "actions@github.com"
          auto-merge: false # we only merge after tests succeed

      # 3️⃣ Enable FlakeHub Cache (for build/test speed)
      - uses: DeterminateSystems/flakehub-cache-action@v2
        with:
          auth-token: ${{ secrets.FLAKEHUB_CACHE_TOKEN }}

      # 4️⃣ Build and test all configurations
      - name: Build all systems
        run: |
          set -eux
          for host in $(nix flake show --json | jq -r '.nixosConfigurations | keys[]'); do
            nix build .#nixosConfigurations.${host}.config.system.build.toplevel
          done

      - name: Run flake checks and tests
        run: |
          # Run all flake-defined checks and tests
          nix flake check --keep-going --print-build-logs

      # 5️⃣ Only push binaries if everything succeeded
      - name: Push binaries to FlakeHub Cache
        if: success()
        uses: DeterminateSystems/flakehub-cache-action@v2
        with:
          auth-token: ${{ secrets.FLAKEHUB_CACHE_TOKEN }}
          push: true

      # 6️⃣ Auto-merge the PR if everything passed
      - name: Merge flake update PR
        if: success()
        run: gh pr merge --auto --merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

